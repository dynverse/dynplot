#' Perform dimensionality reduction on a trajectory and the respective samples in order to plot it
#'
#' @param traj The trajectory
#'
#' @importFrom igraph graph_from_data_frame layout_with_kk
#' @importFrom testthat expect_true
#' @importFrom grDevices col2rgb rgb colorRampPalette
#' @importFrom RColorBrewer brewer.pal
#'
#' @export
dimred_trajectory <- function(
  traj
) {
  # expect traj to contain a trajectory
  testthat::expect_true(is_data_wrapper(traj))
  testthat::expect_true(is_wrapper_with_trajectory(traj))

  # retrieve some objects to work with
  name <- traj$id
  cell_ids <- traj$cell_ids
  milestone_ids <- traj$milestone_ids
  num_milestones <- length(milestone_ids)
  milestone_network <- traj$milestone_network %>%
    filter(to != "FILTERED_CELLS")
  milestone_percentages <- traj$milestone_percentages
  is_directed <- any(traj$milestone_network$directed)

  # add phantom links, ifneedbe
  if (is_directed) {
    structure <- add_phantom_edges(milestone_ids, milestone_network)
  } else {
    structure <- milestone_network
  }

  # adjust weights on structure to make it easier to plot
  if (min(structure$length) * 3 < max(structure$length)) {
    structure <- structure %>% mutate(
      length = sqrt(dynutils::scale_minmax(length) + .5)
    )
  }

  # reduce dimensionality on milestone_network
  gr <- igraph::graph_from_data_frame(structure %>% rename(weight = length), vertices = milestone_ids)
  layout <-
    if (length(igraph::V(gr)) > 2) {
      igraph::layout_with_kk(gr, maxiter = 10000)
    } else {
      igraph::layout.auto(gr)
    }
  layout <- layout %>%
    dynutils::scale_uniform() %>%
    set_rownames(milestone_ids) %>%
    set_colnames(paste0("comp_", seq_len(ncol(.))))
  space_milest_df <- layout %>%
    as.data.frame() %>%
    rownames_to_column()

  # project dimensionality to samples
  mix_dimred <- function(milid, milpct) {
    apply(layout[milid,,drop = FALSE], 2, function(x) sum(x * milpct)) %>% t %>% as_data_frame
  }

  # create output for samples
  space_samples <- milestone_percentages %>%
    group_by(cell_id) %>%
    do(mix_dimred(.$milestone_id, .$percentage)) %>%
    ungroup %>%
    slice(match(cell_ids, cell_id)) %>%
    mutate(name)

  # create output for milestones
  space_milestones <- space_milest_df %>%
    rename(milestone_id = rowname) %>%
    mutate(
      name
    )

  # create output for edges between milestones
  space_lines <- milestone_network %>%
    mutate(name) %>%
    left_join(space_milest_df %>% select(from = rowname, from.comp_1 = comp_1, from.comp_2 = comp_2), by = "from") %>%
    left_join(space_milest_df %>% select(to = rowname, to.comp_1 = comp_1, to.comp_2 = comp_2), by = "to")

  # return all output
  l <- lst(
    id = traj$id,
    space_milestones = space_milestones,
    space_lines = space_lines,
    space_samples = space_samples
  )
  class(l) <- c("dynplot::ti_dimred_wrapper", "list")
  l
}

#' Perform dimred trajectory if needed
#' @param object An object generated by \code{wrap_data} or \code{dimred_trajectory}.
#' @inheritParams dimred_trajectory
check_or_perform_dimred <- dynutils::inherit_default_params(
  list(dimred_trajectory),
  function(
    object
  ) {
    if (is_data_wrapper(object) && is_wrapper_with_trajectory(object)) {
      dimred_object <- dimred_trajectory(
        object
      )
    } else if (is_ti_dimred_wrapper(object)) {
      dimred_object <- object
    } else {
      stop(sQuote("object"), " is not an object as generated by wrap_data or dimred_trajectory")
    }
    dimred_object
  }
)

is_ti_dimred_wrapper <- function(object) {
  "dynplot::ti_dimred_wrapper" %in% class(object)
}

# This is solely used to create spacing between nodes in dimred_trajectory

#' @importFrom reshape2 melt
#' @importFrom igraph graph_from_data_frame neighbors
add_phantom_edges <- function(milestone_ids, milestone_network) {
  is_directed <- any(milestone_network$directed)

  if (is_directed) {
    phantom_links1 <- bind_rows(lapply(milestone_ids, function(x) {
      strx <- milestone_network %>%
        filter(from == x)

      if (nrow(strx) > 1) {
        strx <- strx %>%
          mutate(
            angle = seq(0, 120/360*pi*2, length.out = n()),
            x = length * cos(angle),
            y = length * sin(angle)
          )
        poss <- strx %>% select(x, y) %>% as.matrix
        rownames(poss) <- strx$to
        poss %>%
          dist %>%
          as.matrix %>%
          reshape2::melt(varnames = c("from", "to"), value.name = "length") %>%
          mutate(from = as.character(from), to = as.character(to), directed = is_directed) %>%
          filter(from != to)
      } else {
        NULL
      }
    }))
    phantom_links2 <- bind_rows(lapply(milestone_ids, function(x) {
      strx <- milestone_network %>%
        filter(to == x)

      if (nrow(strx) > 1) {
        strx <- strx %>%
          mutate(
            angle = seq(0, 120/360*pi*2, length.out = n()),
            x = length * cos(angle),
            y = length * sin(angle)
          )
        poss <- strx %>% select(x, y) %>% as.matrix
        rownames(poss) <- strx$from
        poss %>%
          dist %>%
          as.matrix %>%
          reshape2::melt(varnames = c("from", "to"), value.name = "length") %>%
          mutate(from = as.character(from), to = as.character(to), directed = is_directed) %>%
          filter(from != to)
      } else {
        NULL
      }
    }))

    bind_rows(milestone_network, phantom_links1, phantom_links2)
  } else {
    gr <- igraph::graph_from_data_frame(milestone_network, directed = is_directed, vertices = milestone_ids)

    phantom_links <- bind_rows(lapply(milestone_ids, function(x) {
      neighs <- igraph::neighbors(gr, x) %>% names()
      strx <- milestone_network %>%
        filter((to == x & from %in% neighs) | (from == x & to %in% neighs))

      if (nrow(strx) > 1) {
        strx <- strx %>%
          mutate(
            angle = seq(0, 120/360*pi*2, length.out = n()),
            x = length * cos(angle),
            y = length * sin(angle)
          )
        poss <- strx %>% select(x, y) %>% as.matrix
        rownames(poss) <- neighs
        poss %>%
          dist %>%
          as.matrix %>%
          reshape2::melt(varnames = c("from", "to"), value.name = "length") %>%
          mutate(from = as.character(from), to = as.character(to), directed = is_directed) %>%
          filter(from != to)
      } else {
        NULL
      }
    }))

    bind_rows(milestone_network, phantom_links)
  }
}
